<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>IP Tracker - Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { font-family: Arial; margin: 0 }
    header { background: #14c7c7; color: #81e2ad; padding: 10px; text-align: center }
    nav { padding: 8px; background: #FF6F00; text-align: center }
    #map { height: 60vh }
    #list { padding: 10px }
    button { background: #fff; border: 1px solid #ccc; border-radius: 5px; padding: 5px 10px; cursor: pointer; }
    button:hover { background: #f0f0f0; }
  </style>
</head>
<body>
  <header><h2>IP Tracker — Dashboard</h2></header>
  <nav>
    <a href="index.html">Home</a> |
    <a href="tracker.html">Reporter (remote)</a> |
    <a href="about.html">About</a> |
    <button onclick="resetDashboard()">Reset Devices</button> |
    <button onclick="loadHistory()">View History</button> |
    <button id="backLiveBtn" onclick="backToLive()" style="display:none;">Back to Live View</button>
  </nav>

  <div id="map"></div>
  <div id="list"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let layers = {};
    let firstLoad = true;
    let viewMode = "live"; // "live" or "history"

    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // -------------------- REFRESH LIVE DEVICES --------------------
    async function refresh() {
      if (viewMode !== "live") return; // do nothing if viewing history

      const res = await fetch('/devices');
      const devices = await res.json();

      document.getElementById('list').innerHTML = devices.map(d =>
        `<div><b>${d.deviceId}</b> — ${d.label || ''} — ${d.publicIP} — ${d.reportedAt}</div>`
      ).join('');

      Object.values(layers).forEach(layer => {
        map.removeLayer(layer.marker);
        map.removeLayer(layer.circle);
      });
      layers = {};

      devices.forEach(d => {
        const lat = d.clientLat || (d.geoip && d.geoip.lat);
        const lon = d.clientLon || (d.geoip && d.geoip.lon);
        if (!lat || !lon) return;

        const marker = L.marker([lat, lon]).addTo(map);
        const circle = L.circle([lat, lon], {
          radius: d.clientLat ? 50 : 50000,
          color: d.clientLat ? 'green' : 'blue',
          fillOpacity: 0.15
        }).addTo(map);

        marker.bindPopup(`
          <b>${d.label || d.deviceId}</b><br>
          IP: ${d.publicIP}<br>
          Reported: ${d.reportedAt}<br>
          Source: ${d.clientLat ? 'Browser GPS' : 'IP Geolocation'}
        `);

        layers[d.deviceId] = { marker, circle };
      });

      if (firstLoad && devices.length) {
        const first = devices[0];
        const fLat = first.clientLat || (first.geoip && first.geoip.lat) || 0;
        const fLon = first.clientLon || (first.geoip && first.geoip.lon) || 0;
        map.setView([fLat, fLon], devices.length === 1 ? 12 : 5);
        firstLoad = false;
      }
    }

    // Refresh every 10s (live mode only)
    setInterval(refresh, 10000);

    // -------------------- RESET DASHBOARD --------------------
    async function resetDashboard() {
      if (confirm("Are you sure you want to clear all devices?")) {
        await fetch('/reset', { method: 'POST' });

        Object.values(layers).forEach(layer => {
          map.removeLayer(layer.marker);
          map.removeLayer(layer.circle);
        });
        layers = {};

        document.getElementById('list').innerHTML = "<em>All devices cleared.</em>";
        refresh();
      }
    }

    // -------------------- LOAD HISTORY --------------------
    async function loadHistory() {
      viewMode = "history";
      document.getElementById("backLiveBtn").style.display = "inline"; // show back button

      const res = await fetch('/history');
      const history = await res.json();

      if (!Array.isArray(history) || !history.length) {
        alert("No saved history found!");
        return;
      }

      // Clear map
      Object.values(layers).forEach(layer => {
        map.removeLayer(layer.marker);
        map.removeLayer(layer.circle);
      });
      layers = {};

      // Populate list
      document.getElementById('list').innerHTML = "<h3>Device History</h3>" + history.map(d =>
        `<div><b>${d.deviceid || d.deviceId}</b> — ${d.label || ''}<br>
        IP: ${d.publicip || d.publicIP}<br>
        Reported: ${new Date(d.reportedat || d.reportedAt).toLocaleString()}</div>`
      ).join('<hr>');

      // Add markers
      history.forEach(d => {
        const lat = d.clientlat || d.clientLat;
        const lon = d.clientlon || d.clientLon;
        if (!lat || !lon) return;

        const marker = L.marker([lat, lon]).addTo(map);
        const circle = L.circle([lat, lon], {
          radius: 80,
          color: 'gray',
          fillOpacity: 0.1
        }).addTo(map);

        marker.bindPopup(`
          <b>${d.label || d.deviceId}</b><br>
          IP: ${d.publicIP}<br>
          Reported: ${new Date(d.reportedAt).toLocaleString()}
        `);

        layers[d.deviceId] = { marker, circle };
      });
    }

    // -------------------- BACK TO LIVE VIEW --------------------
    function backToLive() {
      viewMode = "live";
      document.getElementById("backLiveBtn").style.display = "none"; // hide button
      document.getElementById('list').innerHTML = "<em>Switched to live mode...</em>";

      // Clear all markers and re-run live refresh
      Object.values(layers).forEach(layer => {
        map.removeLayer(layer.marker);
        map.removeLayer(layer.circle);
      });
      layers = {};
      firstLoad = true;
      refresh();
    }

    // -------------------- INITIALIZE --------------------
    refresh();
  </script>
</body>
</html>
